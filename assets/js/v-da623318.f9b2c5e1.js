(self.webpackChunkXray_docs_next=self.webpackChunkXray_docs_next||[]).push([[3430],{9587:(n,s,a)=>{"use strict";a.r(s),a.d(s,{data:()=>e});const e={key:"v-da623318",path:"/document/level-1/fallbacks-with-sni.html",title:"SNI 回落",lang:"zh-CN",frontmatter:{title:"SNI 回落"},excerpt:"",headers:[{level:2,title:"应用情景",slug:"应用情景",children:[]},{level:2,title:"SNI 简介",slug:"sni-简介",children:[]},{level:2,title:"思路",slug:"思路",children:[]},{level:2,title:"添加 DNS 记录",slug:"添加-dns-记录",children:[]},{level:2,title:"申请 TLS 证书",slug:"申请-tls-证书",children:[]},{level:2,title:"Xray 配置",slug:"xray-配置",children:[]},{level:2,title:"Nginx 配置",slug:"nginx-配置",children:[]},{level:2,title:"Caddy 配置",slug:"caddy-配置",children:[]},{level:2,title:"参考",slug:"参考",children:[]},{level:2,title:"引用",slug:"引用",children:[]}],filePathRelative:"document/level-1/fallbacks-with-sni.md",git:{updatedTime:1626366562e3,contributors:[]}}},3593:(n,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>Kn});var e=a(6252);const l=a.p+"assets/img/xray-fallbacks.f1e5890a.svg",m=a.p+"assets/img/xray-dns-records.2ea37bda.webp",t=a.p+"assets/img/cf-api-token-permissions-for-acme.1f3ce429.webp",r=(0,e.Wm)("h1",{id:"通过-sni-回落功能实现伪装与按域名分流",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#通过-sni-回落功能实现伪装与按域名分流","aria-hidden":"true"},"#"),(0,e.Uk)(" 通过 SNI 回落功能实现伪装与按域名分流")],-1),o=(0,e.Wm)("p",null,"VLESS 是一种很轻的协议，和 Trojan 一样，不对流量进行复杂的加密和混淆，而是大隐隐于市，通过 TLS 协议加密，混杂在其他 HTTPS 流量中，在墙内外穿进穿出。为了更好的伪装以应对主动探测，Fallbacks 回落功能随 VLESS 同时出现。这篇教程将演示如何使用 Xray 中 VLESS 入站协议的回落功能配合 Nginx 或 Caddy 在保证伪装完全的前提下实现按域名分流。",-1),p=(0,e.Wm)("h2",{id:"应用情景",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#应用情景","aria-hidden":"true"},"#"),(0,e.Uk)(" 应用情景")],-1),c=(0,e.Wm)("p",null,"由于 XTLS，Xray 需要监听 443 端口，这导致如果之前有网站运行在服务器上，那么此时网站无法运行或需要运行在其他端口上，这显然是不合理的。有以下三种方案可以解决这个问题：",-1),W=(0,e.Wm)("ul",null,[(0,e.Wm)("li",null,[(0,e.Wm)("p",null,"Xray 监听其他常用端口（如 22、3389、8443）"),(0,e.Wm)("p",null,"这个方案是最简单的，但不够完美。")]),(0,e.Wm)("li",null,[(0,e.Wm)("p",null,"Nginx 或 HAProxy 监听 443 端口，通过 SNI 分流做 L4 反向代理，实现端口复用"),(0,e.Wm)("p",null,"这个方案比较复杂，需要对 Nginx 或 HAProxy 的使用有一定了解，此处不作过多解释。")]),(0,e.Wm)("li",null,[(0,e.Wm)("p",null,"Xray 监听 443 端口，通过 Fallbacks 功能 SNI 分流将网站流量回落到 Nginx 或 Caddy"),(0,e.Wm)("p",null,"这个方案难度适中，也是此教程接下来想要演示的方案。")])],-1),k=(0,e.Wm)("h2",{id:"sni-简介",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#sni-简介","aria-hidden":"true"},"#"),(0,e.Uk)(" SNI 简介")],-1),i=(0,e.Wm)("p",null,[(0,e.Uk)("服务器名称指示（英语："),(0,e.Wm)("strong",null,"S"),(0,e.Uk)("erver "),(0,e.Wm)("strong",null,"N"),(0,e.Uk)("ame "),(0,e.Wm)("strong",null,"I"),(0,e.Uk)("ndication，缩写："),(0,e.Wm)("strong",null,"SNI"),(0,e.Uk)("）是 TLS 的一个扩展协议。熟悉反向代理的朋友都知道，如果想要通过域名将流量代理到正确的内容上，需要以下配置：")],-1),u=(0,e.Wm)("div",{class:"language-nginx ext-nginx line-numbers-mode"},[(0,e.Wm)("pre",{class:"language-nginx"},[(0,e.Wm)("code",null,[(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"proxy_set_header"),(0,e.Uk)(" Host 主机名")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n")])]),(0,e.Wm)("div",{class:"line-numbers"},[(0,e.Wm)("span",{class:"line-number"},"1"),(0,e.Wm)("br")])],-1),b=(0,e.Wm)("p",null,"这句的作用是将名为 “Host” 的 HTTP Header 设定为某个主机名。为什么要这样做？一般而言，一台服务器对应一个 IP，但却运行多个网站，访问者通过域名查询到 IP 以访问服务器，那么问题来了，如何确定访问者想要访问的是哪一个网站？这需要“基于名称的虚拟主机”。",-1),U=(0,e.Wm)("p",null,"当 Web 服务器收到访问请求后，它会查看请求的主机头，使访问者访问正确的网站。然而当 HTTP 协议被 TLS 协议加密后，这种简单的方法就无法实现了。因为 TLS 握手发生在服务器看到任何 HTTP 头之前，因此，服务器不可能使用 HTTP 主机头中的信息来决定呈现哪个证书，更无法决定访问者的访问目标。",-1),d=(0,e.Wm)("p",null,[(0,e.Uk)("SNI 的原理也很简单，它通过让客户端发送主机名作为 TLS 协商的一部分来解决此问题。所以在使用 Nginx 对 HTTPS 协议进行反向代理时，需要在配置中加入 "),(0,e.Wm)("code",null,"proxy_ssl_server_name on;"),(0,e.Uk)("，此时 Nginx 会向被代理的服务器发送 SNI 信息，解决了 HTTPS 协议下虚拟主机失效的问题。另外，使用 SNI 时，即使不指定主机头，也可以正确访问网站。")],-1),h=(0,e.Wm)("h2",{id:"思路",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#思路","aria-hidden":"true"},"#"),(0,e.Uk)(" 思路")],-1),f=(0,e.Wm)("p",null,[(0,e.Wm)("img",{src:l,alt:"Xray 回落流程"})],-1),g=(0,e.Wm)("p",null,"从 443 端口接收到流量后，Xray 会把 TLS 解密后首包长度 < 18、协议版本无效或身份认证失败的流量通过对 name、path、alpn 的匹配转发到 dest 指定的地址。",-1),y=(0,e.Wm)("h2",{id:"添加-dns-记录",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#添加-dns-记录","aria-hidden":"true"},"#"),(0,e.Uk)(" 添加 DNS 记录")],-1),x=(0,e.Wm)("p",null,[(0,e.Wm)("img",{src:m,alt:"DNS 记录"})],-1),v=(0,e.Wm)("p",null,"请按实际情况修改域名和 IP。",-1),T=(0,e.Wm)("h2",{id:"申请-tls-证书",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#申请-tls-证书","aria-hidden":"true"},"#"),(0,e.Uk)(" 申请 TLS 证书")],-1),w=(0,e.Uk)("由于要对不同前缀的域名进行分流，但一个通配符证书的作用域仅限于两“.”之间（例如：申请 "),P=(0,e.Wm)("code",null,"*.example.com",-1),S=(0,e.Uk)("，"),_=(0,e.Wm)("code",null,"example.com",-1),N=(0,e.Uk)(" 和 "),H=(0,e.Wm)("code",null,"*.*.example.com",-1),C=(0,e.Uk)(" 并不能使用该证书），故需申请 "),L={href:"https://zh.wikipedia.org/wiki/%E4%B8%BB%E9%A2%98%E5%A4%87%E7%94%A8%E5%90%8D%E7%A7%B0",target:"_blank",rel:"noopener noreferrer"},I=(0,e.Uk)("SAN"),E=(0,e.Uk)(" 通配符证书。根据 Let's Encrypt 官网信息"),A=(0,e.Wm)("sup",{class:"footnote-ref"},[(0,e.Wm)("a",{href:"#fn1",id:"fnref1"},"[1]")],-1),j=(0,e.Uk)("，申请通配符证书要求 DNS-01 验证方式，此处演示 NS 记录为 Cloudflare 的域名通过 "),X={href:"https://acme.sh",target:"_blank",rel:"noopener noreferrer"},D=(0,e.Uk)("acme.sh"),F=(0,e.Uk)(" 申请 Let's Encrypt 的免费 TLS 证书。使用其他域名托管商的申请方法请阅读 "),B={href:"https://github.com/acmesh-official/acme.sh/wiki/dnsapi",target:"_blank",rel:"noopener noreferrer"},z=(0,e.Uk)("dnsapi · acmesh-official/acme.sh Wiki"),V=(0,e.Uk)("。"),R=(0,e.Uk)("首先需要到 "),q={href:"https://dash.cloudflare.com/profile/api-tokens",target:"_blank",rel:"noopener noreferrer"},$=(0,e.Uk)("Cloudflare 面板"),O=(0,e.Uk)("创建 API Token。参数如下："),Y=(0,e.Wm)("p",null,[(0,e.Wm)("img",{src:t,alt:"API Token 的权限设置"})],-1),G=(0,e.Wm)("p",null,"权限部分至关重要，其他部分任意。",-1),J=(0,e.Wm)("p",null,[(0,e.Uk)("创建完毕后，你会得到一串神秘字符，请将其妥善保管到安全且不会丢失的地方，因为它不再会显示。这串字符就是即将用到的 "),(0,e.Wm)("code",null,"CF_Token"),(0,e.Uk)("。")],-1),K=(0,e.Wm)("div",{class:"custom-container tip"},[(0,e.Wm)("p",{class:"custom-container-title"},"注意"),(0,e.Wm)("p",null,"以下操作需要在 root 用户下进行，使用 sudo 会出现错误。")],-1),M=(0,e.Wm)("div",{class:"language-bash ext-sh line-numbers-mode"},[(0,e.Wm)("pre",{class:"language-bash"},[(0,e.Wm)("code",null,[(0,e.Wm)("span",{class:"token function"},"curl"),(0,e.Uk)(" https://get.acme.sh "),(0,e.Wm)("span",{class:"token operator"},"|"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"sh"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token comment"},"# 安装 acme.sh"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token builtin class-name"},"export"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token assign-left variable"},"CF_Token"),(0,e.Wm)("span",{class:"token operator"},"="),(0,e.Wm)("span",{class:"token string"},'"sdfsdfsdfljlbjkljlkjsdfoiwje"'),(0,e.Uk)(),(0,e.Wm)("span",{class:"token comment"},"# 设定 API Token 变量"),(0,e.Uk)("\nacme.sh --issue -d example.com -d *.example.com --dns dns_cf "),(0,e.Wm)("span",{class:"token comment"},"# 使用 DNS-01 验证方式申请证书"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token function"},"mkdir"),(0,e.Uk)(" /etc/ssl/xray "),(0,e.Wm)("span",{class:"token comment"},"# 新建证书存放目录"),(0,e.Uk)("\nacme.sh --install-cert -d example.com --fullchain-file /etc/ssl/xray/cert.pem --key-file /etc/ssl/xray/privkey.key --reloadcmd "),(0,e.Wm)("span",{class:"token string"},'"chown nobody:nogroup -R /etc/ssl/xray && systemctl restart xray"'),(0,e.Uk)(),(0,e.Wm)("span",{class:"token comment"},"# 安装证书到指定目录并设定自动续签生效指令"),(0,e.Uk)("\n")])]),(0,e.Wm)("div",{class:"line-numbers"},[(0,e.Wm)("span",{class:"line-number"},"1"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"2"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"3"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"4"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"5"),(0,e.Wm)("br")])],-1),Q=(0,e.Wm)("h2",{id:"xray-配置",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#xray-配置","aria-hidden":"true"},"#"),(0,e.Uk)(" Xray 配置")],-1),Z=(0,e.Wm)("div",{class:"language-json ext-json line-numbers-mode"},[(0,e.Wm)("pre",{class:"language-json"},[(0,e.Wm)("code",null,[(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n  "),(0,e.Wm)("span",{class:"token property"},'"log"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token property"},'"loglevel"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"warning"'),(0,e.Uk)("\n  "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n  "),(0,e.Wm)("span",{class:"token property"},'"inbounds"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"["),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"port"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"443"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"protocol"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"vless"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"settings"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token property"},'"clients"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"["),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"id"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"UUID"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"flow"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"xtls-rprx-direct"'),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token punctuation"},"]"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token property"},'"decryption"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"none"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token property"},'"fallbacks"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"["),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"name"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"example.com"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"path"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"/vmessws"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"dest"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"5000"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"xver"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"1"),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"dest"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"5001"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"xver"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"1"),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"alpn"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"h2"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"dest"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"5002"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"xver"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"1"),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"name"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"blog.example.com"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"dest"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"5003"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"xver"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"1"),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"name"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"blog.example.com"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"alpn"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"h2"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"dest"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"5004"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"xver"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"1"),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token punctuation"},"]"),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"streamSettings"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token property"},'"network"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"tcp"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token property"},'"security"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"xtls"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token property"},'"xtlsSettings"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token property"},'"alpn"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"["),(0,e.Wm)("span",{class:"token string"},'"h2"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"http/1.1"'),(0,e.Wm)("span",{class:"token punctuation"},"]"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token property"},'"certificates"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"["),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n              "),(0,e.Wm)("span",{class:"token property"},'"certificateFile"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"/etc/ssl/xray/cert.pem"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n              "),(0,e.Wm)("span",{class:"token property"},'"keyFile"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"/etc/ssl/xray/privkey.key"'),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"]"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"listen"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"127.0.0.1"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"port"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"5000"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"protocol"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"vmess"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"settings"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token property"},'"clients"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"["),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token property"},'"id"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"UUID"'),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token punctuation"},"]"),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"streamSettings"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token property"},'"network"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"ws"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token property"},'"wsSettings"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token property"},'"acceptProxyProtocol"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token boolean"},"true"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n          "),(0,e.Wm)("span",{class:"token property"},'"path"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"/vmessws"'),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n  "),(0,e.Wm)("span",{class:"token punctuation"},"]"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n  "),(0,e.Wm)("span",{class:"token property"},'"outbounds"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"["),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"protocol"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"freedom"'),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n  "),(0,e.Wm)("span",{class:"token punctuation"},"]"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e.Wm)("div",{class:"line-numbers"},[(0,e.Wm)("span",{class:"line-number"},"1"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"2"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"3"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"4"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"5"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"6"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"7"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"8"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"9"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"10"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"11"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"12"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"13"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"14"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"15"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"16"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"17"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"18"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"19"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"20"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"21"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"22"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"23"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"24"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"25"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"26"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"27"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"28"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"29"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"30"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"31"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"32"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"33"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"34"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"35"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"36"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"37"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"38"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"39"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"40"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"41"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"42"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"43"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"44"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"45"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"46"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"47"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"48"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"49"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"50"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"51"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"52"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"53"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"54"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"55"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"56"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"57"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"58"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"59"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"60"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"61"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"62"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"63"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"64"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"65"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"66"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"67"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"68"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"69"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"70"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"71"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"72"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"73"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"74"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"75"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"76"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"77"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"78"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"79"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"80"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"81"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"82"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"83"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"84"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"85"),(0,e.Wm)("br")])],-1),nn=(0,e.Wm)("p",null,"以上配置针对于 Nginx，以下是需要注意的一些细节。",-1),sn=(0,e.Wm)("ul",null,[(0,e.Wm)("li",null,[(0,e.Wm)("p",null,"有关 Proxy Protocol"),(0,e.Wm)("p",null,"Proxy Protocol 是 HaProxy 开发的一种旨在解决代理时容易丢失客户端信息问题的协议，常用于链式代理和反向代理。传统的处理方法往往较为复杂且有诸多限制，而 Proxy Protocol 非常简单地在传输数据时附带上原始连接四元组信息的数据包，解决了这个问题。"),(0,e.Wm)("p",null,"凡事皆有利弊，Proxy Protocol 也是如此。"),(0,e.Wm)("ul",null,[(0,e.Wm)("li",null,"有发送必须有接收，反之亦然"),(0,e.Wm)("li",null,[(0,e.Uk)("同一端口不能既兼容带 Proxy Protocol 数据的连接又兼容不带数据的连接（如：Nginx 同端口的不同虚拟主机（server），本质是上一条）"),(0,e.Wm)("sup",{class:"footnote-ref"},[(0,e.Wm)("a",{href:"#fn2",id:"fnref2"},"[2]")]),(0,e.Wm)("sup",{class:"footnote-ref"},[(0,e.Wm)("a",{href:"#fn3",id:"fnref3"},"[3]")])])]),(0,e.Wm)("p",null,"在遇到异常时，请考虑配置是否符合上述条件。"),(0,e.Wm)("p",null,"此处，我们使用 Proxy Protocol 让被回落到的目标获取到客户端的真实 IP。"),(0,e.Wm)("p",null,[(0,e.Uk)("另外，当 Xray 的某个入站配置存在 "),(0,e.Wm)("code",null,'"acceptProxyProtocol": true'),(0,e.Uk)(" 时，ReadV 将失效。")])]),(0,e.Wm)("li",null,[(0,e.Wm)("p",null,"有关 HTTP/2"),(0,e.Wm)("p",null,[(0,e.Uk)("首先，"),(0,e.Wm)("code",null,"inbounds.streamSettings.xtlsSettings.alpn"),(0,e.Uk)(" 有顺序，应将 "),(0,e.Wm)("code",null,"h2"),(0,e.Uk)(" 放前，"),(0,e.Wm)("code",null,"http/1.1"),(0,e.Uk)(" 放后，在优先使用 HTTP/2 的同时保证兼容性；反过来会导致 HTTP/2 在协商时变为 HTTP/1.1，成为无效配置。")]),(0,e.Wm)("p",null,[(0,e.Uk)("在上述配置中，每条回落到 Nginx 的配置都要分成两个。这是因为 h2 是强制 TLS 加密的 HTTP/2 连接，这有益于数据在互联网中传输的安全，但在服务器内部没有必要；而 h2c 是非加密的 HTTP/2 连接，适合该环境。然而，Nginx 不能在同一端口上同时监听 HTTP/1.1 和 h2c，为了解决这个问题，需要在回落中指定 "),(0,e.Wm)("code",null,"alpn"),(0,e.Uk)(" 项（是 "),(0,e.Wm)("code",null,"fallbacks"),(0,e.Uk)(" 而不是 "),(0,e.Wm)("code",null,"xtlsSettings"),(0,e.Uk)(" 里面的），以尝试匹配 TLS ALPN 协商结果。")]),(0,e.Wm)("p",null,[(0,e.Uk)("建议 "),(0,e.Wm)("code",null,"alpn"),(0,e.Uk)(" 项只按需用两种填法："),(0,e.Wm)("sup",{class:"footnote-ref"},[(0,e.Wm)("a",{href:"#fn4",id:"fnref4"},"[4]")])]),(0,e.Wm)("ul",null,[(0,e.Wm)("li",null,"省略"),(0,e.Wm)("li",null,[(0,e.Wm)("code",null,'"h2"')])]),(0,e.Wm)("p",null,[(0,e.Uk)("如果使用 Caddy 就大可不必如此繁杂了，因为它"),(0,e.Wm)("strong",null,"可以"),(0,e.Uk)("在同一端口上同时监听 HTTP/1.1 和 h2c，配置改动如下：")]),(0,e.Wm)("div",{class:"language-json ext-json line-numbers-mode"},[(0,e.Wm)("pre",{class:"language-json"},[(0,e.Wm)("code",null,[(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n  "),(0,e.Wm)("span",{class:"token property"},'"fallbacks"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"["),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"name"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"example.com"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"path"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"/vmessws"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"dest"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"5000"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"xver"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"1"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"dest"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"5001"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"xver"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"1"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"name"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"blog.example.com"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"dest"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"5002"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)("\n      "),(0,e.Wm)("span",{class:"token property"},'"xver"'),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"1"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n  "),(0,e.Wm)("span",{class:"token punctuation"},"]"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e.Wm)("div",{class:"line-numbers"},[(0,e.Wm)("span",{class:"line-number"},"1"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"2"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"3"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"4"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"5"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"6"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"7"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"8"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"9"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"10"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"11"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"12"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"13"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"14"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"15"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"16"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"17"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"18"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"19"),(0,e.Wm)("br")])])])],-1),an=(0,e.Wm)("h2",{id:"nginx-配置",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#nginx-配置","aria-hidden":"true"},"#"),(0,e.Uk)(" Nginx 配置")],-1),en=(0,e.Wm)("p",null,"Nginx 将通过官方源进行安装。",-1),ln=(0,e.Wm)("div",{class:"language-bash ext-sh line-numbers-mode"},[(0,e.Wm)("pre",{class:"language-bash"},[(0,e.Wm)("code",null,[(0,e.Wm)("span",{class:"token function"},"sudo"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"apt"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"install"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"curl"),(0,e.Uk)(" gnupg2 ca-certificates lsb-release\n"),(0,e.Wm)("span",{class:"token builtin class-name"},"echo"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},[(0,e.Uk)('"deb [arch=amd64] http://nginx.org/packages/ubuntu '),(0,e.Wm)("span",{class:"token variable"},[(0,e.Wm)("span",{class:"token variable"},"`"),(0,e.Uk)("lsb_release -cs"),(0,e.Wm)("span",{class:"token variable"},"`")]),(0,e.Uk)(' nginx"')]),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"\\"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token operator"},"|"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"sudo"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"tee"),(0,e.Uk)(" /etc/apt/sources.list.d/nginx.list\n"),(0,e.Wm)("span",{class:"token function"},"curl"),(0,e.Uk)(" -fsSL https://nginx.org/keys/nginx_signing.key "),(0,e.Wm)("span",{class:"token operator"},"|"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"sudo"),(0,e.Uk)(" apt-key "),(0,e.Wm)("span",{class:"token function"},"add"),(0,e.Uk)(" -\n"),(0,e.Wm)("span",{class:"token function"},"sudo"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"apt"),(0,e.Uk)(" update\n"),(0,e.Wm)("span",{class:"token function"},"sudo"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"apt"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"install"),(0,e.Uk)(" nginx\n")])]),(0,e.Wm)("div",{class:"line-numbers"},[(0,e.Wm)("span",{class:"line-number"},"1"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"2"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"3"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"4"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"5"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"6"),(0,e.Wm)("br")])],-1),mn=(0,e.Wm)("p",null,[(0,e.Uk)("删除 "),(0,e.Wm)("code",null,"/etc/nginx/conf.d/default.conf"),(0,e.Uk)(" 并创建 "),(0,e.Wm)("code",null,"/etc/nginx/conf.d/fallbacks.conf"),(0,e.Uk)("，内容如下：")],-1),tn=(0,e.Wm)("div",{class:"language-nginx ext-nginx line-numbers-mode"},[(0,e.Wm)("pre",{class:"language-nginx"},[(0,e.Wm)("code",null,[(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"set_real_ip_from"),(0,e.Uk)(" 127.0.0.1")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"real_ip_header"),(0,e.Uk)(" proxy_protocol")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n"),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"server")]),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"listen"),(0,e.Uk)(" 127.0.0.1:5001 proxy_protocol default_server")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"listen"),(0,e.Uk)(" 127.0.0.1:5002 proxy_protocol default_server http2")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n    "),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"location"),(0,e.Uk)(" /")]),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"root"),(0,e.Uk)(" /srv/http/default")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n\n"),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"server")]),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"listen"),(0,e.Uk)(" 127.0.0.1:5003 proxy_protocol")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"listen"),(0,e.Uk)(" 127.0.0.1:5004 proxy_protocol http2")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n    "),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"server_name"),(0,e.Uk)(" blog.example.com")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n    "),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"location"),(0,e.Uk)(" /")]),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"root"),(0,e.Uk)(" /srv/http/blog.example.com")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n\n"),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"server")]),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"listen"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"80")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token directive"},[(0,e.Wm)("span",{class:"token keyword"},"return"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"301"),(0,e.Uk)(" https://"),(0,e.Wm)("span",{class:"token variable"},"$host"),(0,e.Wm)("span",{class:"token variable"},"$request_uri")]),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e.Wm)("div",{class:"line-numbers"},[(0,e.Wm)("span",{class:"line-number"},"1"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"2"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"3"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"4"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"5"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"6"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"7"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"8"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"9"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"10"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"11"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"12"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"13"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"14"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"15"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"16"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"17"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"18"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"19"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"20"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"21"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"22"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"23"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"24"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"25"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"26"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"27"),(0,e.Wm)("br")])],-1),rn=(0,e.Wm)("h2",{id:"caddy-配置",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#caddy-配置","aria-hidden":"true"},"#"),(0,e.Uk)(" Caddy 配置")],-1),on=(0,e.Uk)("安装 Caddy 请参阅 "),pn={href:"https://caddyserver.com/docs/install",target:"_blank",rel:"noopener noreferrer"},cn=(0,e.Uk)("Install — Caddy Documentation"),Wn=(0,e.Uk)("。"),kn=(0,e.Wm)("p",null,"为了使 Caddy 能获取到访问者的真实 IP，需要编译带有 Proxy Protocol 模块的 Caddy。建议直接在 Caddy 官网上在线编译。",-1),un=(0,e.Wm)("div",{class:"language-bash ext-sh line-numbers-mode"},[(0,e.Wm)("pre",{class:"language-bash"},[(0,e.Wm)("code",null,[(0,e.Wm)("span",{class:"token function"},"sudo"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"curl"),(0,e.Uk)(" -o /usr/bin/caddy "),(0,e.Wm)("span",{class:"token string"},'"https://caddyserver.com/api/download?os=linux&arch=amd64&p=github.com%2Fmastercactapus%2Fcaddy2-proxyprotocol&idempotency=79074247675458"'),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token function"},"sudo"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"chmod"),(0,e.Uk)(" +x /usr/bin/caddy\n")])]),(0,e.Wm)("div",{class:"line-numbers"},[(0,e.Wm)("span",{class:"line-number"},"1"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"2"),(0,e.Wm)("br")])],-1),bn=(0,e.Wm)("p",null,"直接替换即可。",-1),Un=(0,e.Wm)("div",{class:"custom-container tip"},[(0,e.Wm)("p",{class:"custom-container-title"},"提示"),(0,e.Wm)("p",null,"建议先通过官网文档安装 Caddy，再替换二进制文件。这样做无需手动设定进程守护。")],-1),dn=(0,e.Wm)("p",null,[(0,e.Uk)("编辑 "),(0,e.Wm)("code",null,"/etc/caddy/Caddyfile"),(0,e.Uk)("：")],-1),hn=(0,e.Wm)("div",{class:"language-Caddyfile ext-Caddyfile line-numbers-mode"},[(0,e.Wm)("pre",{class:"language-Caddyfile"},[(0,e.Wm)("code",null,"{\n    servers 127.0.0.1:5001 {\n        listener_wrappers {\n            proxy_protocol\n        }\n\tprotocol {\n            allow_h2c\n        }\n    }\n    servers 127.0.0.1:5002 {\n        listener_wrappers {\n            proxy_protocol\n        }\n\tprotocol {\n            allow_h2c\n        }\n    }\n}\n\n:5001 {\n    root * /srv/http/default\n    file_server\n    log\n    bind 127.0.0.1\n}\n\nhttp://blog.example.com:5002 {\n    root * /srv/http/blog.example.com\n    file_server\n    log\n    bind 127.0.0.1\n}\n\n:80 {\n    redir https://{host}{uri} permanent\n}\n")]),(0,e.Wm)("div",{class:"line-numbers"},[(0,e.Wm)("span",{class:"line-number"},"1"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"2"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"3"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"4"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"5"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"6"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"7"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"8"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"9"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"10"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"11"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"12"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"13"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"14"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"15"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"16"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"17"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"18"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"19"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"20"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"21"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"22"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"23"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"24"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"25"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"26"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"27"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"28"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"29"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"30"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"31"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"32"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"33"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"34"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"35"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"36"),(0,e.Wm)("br")])],-1),fn=(0,e.Wm)("h2",{id:"参考",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#参考","aria-hidden":"true"},"#"),(0,e.Uk)(" 参考")],-1),gn={href:"https://zh.wikipedia.org/wiki/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%8D%E7%A7%B0%E6%8C%87%E7%A4%BA",target:"_blank",rel:"noopener noreferrer"},yn=(0,e.Uk)("服务器名称指示 - 维基百科，自由的百科全书"),xn={href:"https://github.com/acmesh-official/acme.sh/wiki",target:"_blank",rel:"noopener noreferrer"},vn=(0,e.Uk)("Home · acmesh-official/acme.sh Wiki"),Tn={href:"https://zh.wikipedia.org/wiki/HTTP/2",target:"_blank",rel:"noopener noreferrer"},wn=(0,e.Uk)("HTTP/2 - 维基百科，自由的百科全书"),Pn=(0,e.Wm)("h2",{id:"引用",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#引用","aria-hidden":"true"},"#"),(0,e.Uk)(" 引用")],-1),Sn=(0,e.Wm)("hr",{class:"footnotes-sep"},null,-1),_n={class:"footnotes"},Nn={class:"footnotes-list"},Hn={id:"fn1",class:"footnote-item"},Cn={href:"https://letsencrypt.org/zh-cn/docs/faq/",target:"_blank",rel:"noopener noreferrer"},Ln=(0,e.Uk)("常见问题 - Let's Encrypt - 免费的 SSL/TLS 证书"),In=(0,e.Uk)(),En=(0,e.Wm)("a",{href:"#fnref1",class:"footnote-backref"},"↩︎",-1),An={id:"fn2",class:"footnote-item"},jn={href:"https://www.haproxy.com/blog/haproxy/proxy-protocol/",target:"_blank",rel:"noopener noreferrer"},Xn=(0,e.Uk)("Proxy Protocol - HAProxy Technologies"),Dn=(0,e.Uk)(),Fn=(0,e.Wm)("a",{href:"#fnref2",class:"footnote-backref"},"↩︎",-1),Bn={id:"fn3",class:"footnote-item"},zn={href:"https://www.jianshu.com/p/cc8d592582c9",target:"_blank",rel:"noopener noreferrer"},Vn=(0,e.Uk)("proxy protocol 介绍及 nginx 配置 - 简书"),Rn=(0,e.Uk)(),qn=(0,e.Wm)("a",{href:"#fnref3",class:"footnote-backref"},"↩︎",-1),$n={id:"fn4",class:"footnote-item"},On={href:"https://github.com/rprx/v2fly-github-io/blob/master/docs/config/protocols/vless.md",target:"_blank",rel:"noopener noreferrer"},Yn=(0,e.Uk)("v2fly-github-io/vless.md at master · rprx/v2fly-github-io"),Gn=(0,e.Uk)(),Jn=(0,e.Wm)("a",{href:"#fnref4",class:"footnote-backref"},"↩︎",-1),Kn={render:function(n,s){const a=(0,e.up)("OutboundLink");return(0,e.wg)(),(0,e.j4)(e.HY,null,[r,o,p,c,W,k,i,u,b,U,d,h,f,g,y,x,v,T,(0,e.Wm)("p",null,[w,P,S,_,N,H,C,(0,e.Wm)("a",L,[I,(0,e.Wm)(a)]),E,A,j,(0,e.Wm)("a",X,[D,(0,e.Wm)(a)]),F,(0,e.Wm)("a",B,[z,(0,e.Wm)(a)]),V]),(0,e.Wm)("p",null,[R,(0,e.Wm)("a",q,[$,(0,e.Wm)(a)]),O]),Y,G,J,K,M,Q,Z,nn,sn,an,en,ln,mn,tn,rn,(0,e.Wm)("p",null,[on,(0,e.Wm)("a",pn,[cn,(0,e.Wm)(a)]),Wn]),kn,un,bn,Un,dn,hn,fn,(0,e.Wm)("ol",null,[(0,e.Wm)("li",null,[(0,e.Wm)("a",gn,[yn,(0,e.Wm)(a)])]),(0,e.Wm)("li",null,[(0,e.Wm)("a",xn,[vn,(0,e.Wm)(a)])]),(0,e.Wm)("li",null,[(0,e.Wm)("a",Tn,[wn,(0,e.Wm)(a)])])]),Pn,Sn,(0,e.Wm)("section",_n,[(0,e.Wm)("ol",Nn,[(0,e.Wm)("li",Hn,[(0,e.Wm)("p",null,[(0,e.Wm)("a",Cn,[Ln,(0,e.Wm)(a)]),In,En])]),(0,e.Wm)("li",An,[(0,e.Wm)("p",null,[(0,e.Wm)("a",jn,[Xn,(0,e.Wm)(a)]),Dn,Fn])]),(0,e.Wm)("li",Bn,[(0,e.Wm)("p",null,[(0,e.Wm)("a",zn,[Vn,(0,e.Wm)(a)]),Rn,qn])]),(0,e.Wm)("li",$n,[(0,e.Wm)("p",null,[(0,e.Wm)("a",On,[Yn,(0,e.Wm)(a)]),Gn,Jn])])])])],64)}}}}]);