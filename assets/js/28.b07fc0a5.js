(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{439:function(t,a,s){"use strict";s.r(a);var e=s(20),r=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"fallback-回落"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fallback-回落"}},[t._v("#")]),t._v(" Fallback 回落")]),t._v(" "),s("blockquote",[s("p",[s("strong",[t._v("Fallback 是 Xray 的最强大功能之一, 可有效防止主动探测, 自由配置常用端口多服务共享")])])]),t._v(" "),s("p",[t._v("fallback 为 Xray 提供了高强度的防主动探测性, 并且具有独创的首包回落机制.")]),t._v(" "),s("p",[t._v("fallback 也可以将不同类型的流量根据 path 进行分流, 从而实现一个端口, 多种服务共享.")]),t._v(" "),s("p",[t._v("目前您可以在使用 VLESS 或者 trojan 协议时, 通过配置 fallbacks 来使用回落这一特性,  并且创造出非常丰富的组合玩法.")]),t._v(" "),s("h2",{attrs:{id:"fallbacks-配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fallbacks-配置"}},[t._v("#")]),t._v(" fallbacks 配置")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"fallbacks"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"dest"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("blockquote",[s("p",[s("code",[t._v("fallbacks")]),t._v(": [ "),s("a",{attrs:{href:"#fallbackobject"}},[t._v("FallbackObject")]),t._v(" ]")])]),t._v(" "),s("p",[t._v("一个数组，包含一系列强大的回落分流配置。")]),t._v(" "),s("h3",{attrs:{id:"fallbackobject"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fallbackobject"}},[t._v("#")]),t._v(" FallbackObject")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"alpn"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"dest"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"xver"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("strong",[s("code",[t._v("fallbacks")]),t._v(" 是一个数组，这里是其中一个子元素的配置说明。")])]),t._v(" "),s("p",[s("code",[t._v("fallbacks")]),t._v(" 项是可选的，只能用于 TCP+TLS 传输组合")]),t._v(" "),s("ul",[s("li",[t._v("该项有子元素时，"),s("RouterLink",{attrs:{to:"/config/transport.html#tlsobject"}},[t._v("Inbound TLS")]),t._v(" 需设置 "),s("code",[t._v('"alpn":["http/1.1"]')]),t._v("。**")],1)]),t._v(" "),s("p",[t._v("通常，你需要先设置一组 "),s("code",[t._v("alpn")]),t._v(" 和 "),s("code",[t._v("path")]),t._v(" 均省略或为空的默认回落，然后再按需配置其它分流。")]),t._v(" "),s("p",[t._v("VLESS 会把 TLS 解密后首包长度 < 18 或协议版本无效、身份认证失败的流量转发到 "),s("code",[t._v("dest")]),t._v(" 指定的地址。")]),t._v(" "),s("p",[t._v("其它传输组合必须删掉 "),s("code",[t._v("fallbacks")]),t._v(" 项或所有子元素，此时也不会开启 Fallback，VLESS 会等待读够所需长度，协议版本无效或身份认证失败时，将直接断开连接。")]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("name")]),t._v(': string\n尝试匹配 TLS SNI(Server Name Indication)，空为任意，默认为 ""')])]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("alpn")]),t._v(": string")])]),t._v(" "),s("p",[t._v('尝试匹配 TLS ALPN 协商结果，空为任意，默认为 ""')]),t._v(" "),s("p",[t._v("有需要时，VLESS 才会尝试读取 TLS ALPN 协商结果，若成功，输出 info "),s("code",[t._v("realAlpn =")]),t._v(" 到日志。\n用途：解决了 Nginx 的 h2c 服务不能同时兼容 http/1.1 的问题，Nginx 需要写两行 listen，分别用于 1.1 和 h2c。\n注意：fallbacks alpn 存在 "),s("code",[t._v('"h2"')]),t._v(" 时，"),s("RouterLink",{attrs:{to:"/config/transport.html#tlsobject"}},[t._v("Inbound TLS")]),t._v(" 需设置 "),s("code",[t._v('"alpn":["h2","http/1.1"]')]),t._v("，以支持 h2 访问。")],1),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("Fallback 内设置的 "),s("code",[t._v("alpn")]),t._v(" 是匹配实际协商出的 ALPN，而 Inbound TLS 设置的 "),s("code",[t._v("alpn")]),t._v(" 是握手时可选的 ALPN 列表，两者含义不同。")])]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("path")]),t._v(": string")])]),t._v(" "),s("p",[t._v("尝试匹配首包 HTTP PATH，空为任意，默认为空，非空则必须以 "),s("code",[t._v("/")]),t._v(" 开头，不支持 h2c。")]),t._v(" "),s("p",[t._v("智能：有需要时，VLESS 才会尝试看一眼 PATH（不超过 55 个字节；最快算法，并不完整解析 HTTP），若成功，输出 INFO 日志 "),s("code",[t._v("realPath =")]),t._v("。\n用途：分流其它 inbound 的 WebSocket 流量或 HTTP 伪装流量，没有多余处理、纯粹转发流量，理论性能比 Nginx 更强。")]),t._v(" "),s("p",[t._v("注意："),s("strong",[t._v("fallbacks 所在入站本身必须是 TCP+TLS")]),t._v("，这是分流至其它 WS 入站用的，被分流的入站则无需配置 TLS。")]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("dest")]),t._v(": string | number")])]),t._v(" "),s("p",[t._v("决定 TLS 解密后 TCP 流量的去向，目前支持两类地址：（该项必填，否则无法启动）")]),t._v(" "),s("ol",[s("li",[t._v("TCP，格式为 "),s("code",[t._v('"addr:port"')]),t._v("，其中 addr 支持 IPv4、域名、IPv6，若填写域名，也将直接发起 TCP 连接（而不走内置的 DNS）。")]),t._v(" "),s("li",[t._v("Unix domain socket，格式为绝对路径，形如 "),s("code",[t._v('"/dev/shm/domain.socket"')]),t._v("，可在开头加 "),s("code",[t._v("@")]),t._v(" 代表 "),s("a",{attrs:{href:"https://www.man7.org/linux/man-pages/man7/unix.7.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("abstract"),s("OutboundLink")],1),t._v("，"),s("code",[t._v("@@")]),t._v(" 则代表带 padding 的 abstract。")])]),t._v(" "),s("p",[t._v("若只填 port，数字或字符串均可，形如 "),s("code",[t._v("80")]),t._v("、"),s("code",[t._v('"80"')]),t._v("，通常指向一个明文 http 服务（addr 会被补为 "),s("code",[t._v('"127.0.0.1"')]),t._v("）。")]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("xver")]),t._v(": number")])]),t._v(" "),s("p",[t._v("发送 "),s("a",{attrs:{href:"https://www.haproxy.org/download/2.2/doc/proxy-protocol.txt",target:"_blank",rel:"noopener noreferrer"}},[t._v("PROXY protocol"),s("OutboundLink")],1),t._v("，专用于传递请求的真实来源 IP 和端口，填版本 1 或 2，默认为 0，即不发送。若有需要建议填 1。")]),t._v(" "),s("p",[t._v("目前填 1 或 2，功能完全相同，只是结构不同，且前者可打印，后者为二进制。Xray 的 TCP 和 WS 入站均已支持接收 PROXY protocol。")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),s("p",[t._v("若你正在 "),s("a",{attrs:{href:"https://docs.nginx.com/nginx/admin-guide/load-balancer/using-proxy-protocol/#configuring-nginx-to-accept-the-proxy-protocol",target:"_blank",rel:"noopener noreferrer"}},[t._v("配置 Nginx 接收 PROXY protocol"),s("OutboundLink")],1),t._v("，除了设置 proxy_protocol 外，还需设置 set_real_ip_from，否则可能会出问题。")])]),t._v(" "),s("h3",{attrs:{id:"补充说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#补充说明"}},[t._v("#")]),t._v(" 补充说明")]),t._v(" "),s("ul",[s("li",[t._v("将匹配到最精确的子元素，与子元素的排列顺序无关。若配置了几个 alpn 和 path 均相同的子元素，则会以最后的为准。")]),t._v(" "),s("li",[t._v("回落分流均是解密后 TCP 层的转发，而不是 HTTP 层，只在必要时检查首包 PATH。")]),t._v(" "),s("li",[t._v("您可以查看更多的关于 Fallbacks 的使用技巧和心得\n"),s("ul",[s("li",[s("a",{attrs:{href:"../documents/level-1/fallbacks-lv1"}},[t._v("Fallbacks 功能简析")])])])])]),t._v(" "),s("h2",{attrs:{id:"fallbacks-设计理论"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fallbacks-设计理论"}},[t._v("#")]),t._v(" Fallbacks 设计理论 "),s("Badge",{attrs:{text:"WIP",type:"warning"}})],1)])}),[],!1,null,null,null);a.default=r.exports}}]);